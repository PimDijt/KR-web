<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>Google maps filter</title>
    <script
			  src="https://code.jquery.com/jquery-3.3.1.js"
			  integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
			  crossorigin="anonymous"></script>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }
      #floating-panel {
        position: absolute;
        top: 10%;
        left: 2%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        font-family: 'Roboto','sans-serif';
        line-height: 30px;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      li, ul {
        list-style-type: none;
      }

    </style>
  </head>
  <body>
    <textarea type="hidden" id="query">
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
SELECT ?sup ?sub WHERE {
  ?supt rdfs:subClassOf+ g13vocab:Location .
  ?supt rdfs:subClassOf? g13vocab:Location .
  ?subt rdfs:subClassOf ?supt .
  ?subt rdfs:label ?sub .
  ?supt rdfs:label ?sup .
  FILTER(?supt != ?subt)
}
</textarea>
    <div id="floating-panel">

    </div>
    <div id="map"></div>
    <script>
      var query = $('#query').val();
      var endpoint = 'http://localhost:5820/KRweb' + '/query';
	    var format = 'JSON';

	    $.get('/sparql2',data={'endpoint': endpoint, 'query': query, 'format': format}, function(json){
        var filter_array = json.results.bindings;
        filter = [];
        var id = 0;
        var sub_id = 0;
        filter_array.forEach(function(item){
          var sup = item.sup;
          var sup_name = sup.value;

          var sub = item.sub;
          var sub_object = {};
          sub_object.name = sub.value;
          sub_object.show = false;
          sub_object.radius = 500;

          var found = false;

          filter.forEach(function(item){
            if(item.name == sup_name){
              //already in, add to objects
              sub_object.id = sub_id;
              item.sub_classes.push(sub_object);

              found = true;
            }
          });

          if(!found){
            //make a new object
            sub_id = 0;
            sub_object.id = sub_id;
            var object = {};
            object.name = sup_name;
            object.id = id;
            object.show = false;
            object.sub_classes = [sub_object];
            filter.push(object);
            id += 1;
          }
          sub_id += 1;
        });


        var div = document.getElementById('floating-panel');
        var ul = document.createElement('ul');
        var li;
        filter.forEach(function(item){
          li = document.createElement('li');

          var radio_name = document.createElement('input');
          //radio_name.setAttribute('checked', true);
          radio_name.setAttribute('type', 'checkbox');
          radio_name.setAttribute('id', item.id);
          radio_name.setAttribute('onclick', 'change_selection(this)');

          var radio_name_label = document.createElement('label');
          radio_name_label.appendChild(document.createTextNode(item.name));

          li.appendChild(radio_name);
          li.appendChild(radio_name_label);


          item.sub_classes.forEach(function(sub){
            var nes_ul = document.createElement('ul');
            var nes_li1 =  document.createElement('li');
            var sub_radio = document.createElement('input');
            //sub_radio.setAttribute('checked', true);
            sub_radio.setAttribute('type', 'checkbox');
            sub_radio.setAttribute('id', item.id.toString()+"_"+sub.id.toString());
            sub_radio.setAttribute('class', 'checks');
            sub_radio.setAttribute('onclick', 'change_selection(this)');

            var sub_radio_label = document.createElement('label');
            sub_radio_label.appendChild(document.createTextNode(sub.name));
            nes_li1.appendChild(sub_radio);
            nes_li1.appendChild(sub_radio_label);

            nes_ul.appendChild(nes_li1);

            var nes_li2 = document.createElement('li');

            var slider = document.createElement('input');
            slider.setAttribute('type', 'range');
            slider.setAttribute('min', 500);
            slider.setAttribute('max', 2000);
            slider.setAttribute('id', item.id.toString()+"_"+sub.id.toString());
            slider.setAttribute('value', 1);
            slider.setAttribute('onchange', 'change_radius(this)');

            nes_li2.appendChild(slider);

            nes_ul.appendChild(nes_li2);

            li.appendChild(nes_ul);
            ul.appendChild(li);
          });
        });
        div.appendChild(ul);
      });



      function change_selection(element){
        var object_id = element.id.split("_");
        if(object_id.length > 1){
          if(element.checked){
            filter[object_id[0]].sub_classes[object_id[1]].show = true;
          }else{
            filter[object_id[0]].sub_classes[object_id[1]].show = false;
          }
        }else{
          if(element.checked){
            filter[object_id[0]].show = true;
          }else{
            filter[object_id[0]].show = false;
            filter[object_id[0]].sub_classes.forEach(function(item){
              item.show = false;
            });
          }
        }
        fire_query();
      }

      function change_radius(element){
        var object_id = element.id.split("_");
        filter[object_id[0]].sub_classes[object_id[1]].radius = element.value;
        fire_query();
      }

      var markers = [];


      function add_marker(id, marker, map, circle, color, radius) {
        var lat_lng = {lat: marker.lat, lng: marker.lng}
        window["marker"+id+"_"+marker.id] = new google.maps.Marker({
          position: lat_lng,
          map: map,
          clickable: true,
        });

        window["marker"+id+"_"+marker.id].info = new google.maps.InfoWindow({
          content: marker.title,
        });
        google.maps.event.addListener(   window["marker"+id+"_"+marker.id], 'click', function() {
            window["marker"+id+"_"+marker.id].info.open(map, window["marker"+id+"_"+marker.id]);
        });

        if(circle){
          var _radius = radius*100
          var cityCircle = new google.maps.Circle({
            strokeColor: color,
            strokeOpacity: 0.5,
            strokeWeight: 1,
            fillColor: color,
            fillOpacity: 0.25,
            map: map,
            center: lat_lng,
            radius: _radius
          });
        }


      }

      function reset_markers() {
        for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(null);
        }
        markers = [];
      }

      function show_map() {
        // Create a map and center it on Amsterdam.

        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 13,
          center: {lat: 52.379189, lng: 4.899431}
        });

        //reset_markers();
        objects.forEach(function(item){
          if(item.show){
            item.markers.forEach(function(marker){
              add_marker(item.id, marker, map, item.circles, item.color, item.radius);
            });
          }
        });

      }

      function fire_query(){
        var query = "SELECT DISTINCT";
        var count = 0;
        var sub_classes = []
        filter.forEach(function(item){
          item.sub_classes.forEach(function(sub_item){
            if(sub_item.show == true){
              sub_classes.push({"name": sub_item.name, "radius": sub_item.radius});
              count += 1;
            }
          });
        });

        for(var i=0; i<count; i++){
          query += " ?lab"+i;
          query += " ?lat"+i;
          query += " ?lng"+i;
        }



        query += " WHERE{\n";
        for(var i=0; i<count; i++){
          query += " ?a"+i+" ns2:latitude ?lat"+i+" .\n";
          query += " ?a"+i+" ns2:longitude ?lng"+i+" .\n";
          query += " ?a"+i+" rdfs:label ?lab"+i+" .\n";
          query += " ?a"+i+" rdf:type ?c"+i+" .\n";
          query += " ?c"+i+" rdfs:label \""+sub_classes[i].name+"\"@en .\n";
        }

        for(var i=0; i<count; i++){
          for(var j=i+1; j<count; j++){
            query += " filter((?lat"+i+"-?lat"+j+")*(?lat"+i+"-?lat"+j+")+(?lng"+i+"-?lng"+j+")*(?lng"+i+"-?lng"+j+")>(100*100)) .";
          }
        }

        query += "\n}";
        console.log(query);
        /*
        ?a rdfs:label ?namea .
        ?a g13vocab:providesSpecialCare g13vocab:night .
        ?b ns2:latitude ?latb .
        ?b ns2:longitude ?lonb .
        ?b rdfs:label ?nameb .
        ?b g13vocab:providesSpecialCare g13vocab:day .
        filter((?lata-?latb)*(?lata-?latb)+(?lona-?lonb)*(?lona-?lonb)>(100*100)) .
        */
      }

      $( ".checks" ).on( "click", function() {
        console.log( "Works" );
        console.log($('#query').val());
      });
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCFMq2vgneKfOxVoPrWNm0NYlnzpUAanq0&callback=show_map">
    </script>
  </body>
</html>
